{% extends 'base.html' %}
{% block title %}Available Houses{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Available Houses</h2>
  <div class="house-list row">
    {% if houses %}
      {% for house in houses %}
        {% if house.owner.role == 'landlord' %}
          <div class="house-card col-md-4 mb-4">
            <div class="card">
              <div class="card-body">
                <h3 class="card-title">{{ house.title }}</h3>
                <p class="card-text">{{ house.description | truncate(150) }}</p>
                <p><strong>Laocation:</strong> {{ house.location }}</p>
                <p><strong>Rent:</strong> ${{ house.rent_amount | float | round(2) }}/month</p>
                <p><strong>Bedrooms:</strong> {{ house.bedrooms }}</p>
                <p><strong>Bathrooms:</strong> {{ house.bathrooms }}</p>
                <p><strong>Property Type:</strong> {{ house.property_type }}</p>
                <p>
                  <strong>Availability:</strong>
                  {{ 'Available' if house.available else 'Not Available' }}
                </p>

                <!-- âœ… Fixed image display -->
                <div class="images">
                  {% if house.image_urls %}
                    {% for url in house.image_urls.split(',') if url %}
                      <img
                        src="{{ url_for('static', filename='images/' ~ url.strip()) }}"
                        alt="{{ house.title }} Image"
                        class="img-fluid mb-2"
                        style="max-height: 150px"
                      />
                    {% endfor %}
                  {% else %}
                    <p>No images available</p>
                  {% endif %}
                </div>

                <a href="{{ url_for('house.book_house', house_id=house.id) }}" class="btn btn-primary mt-2">Book</a>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p>No houses available at the moment.</p>
    {% endif %}
  </div>

  <!-- Chat Widget -->
  <div id="chat-widget" class="chat-widget" style="display: none">
    <div class="chat-header">
      Chat with Support
      <button id="close-chat" class="btn btn-sm btn-secondary">X</button>
    </div>
    <ul id="chat-messages" style="height: 300px; overflow-y: auto; padding: 10px"></ul>
    <form id="chat-form">
      <div class="input-group">
        <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." />
        <div class="input-group-append">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Send
          </button>
        </div>
      </div>
    </form>
    <form id="file-form" action="{{ url_for('support.upload_file') }}" method="post" enctype="multipart/form-data">
      <input type="file" id="file-input" name="file" style="display: none" accept=".png,.jpg,.jpeg,.gif,.pdf" />
      <button type="button" id="upload-file-btn" class="btn btn-sm btn-secondary mt-2">
        <i class="fas fa-paperclip"></i> Attach
      </button>
    </form>
    {% if current_user.is_authenticated %}
      <a href="{{ url_for('support.chat') }}" class="btn btn-sm btn-primary mt-2">Go to Full Chat</a>
      {% if current_user.role.lower() == 'landlord' %}
        <a href="{{ url_for('house.add_house') }}" class="btn btn-sm btn-info mt-2">List Property</a>
      {% endif %}
      {% if current_user.role.lower() == 'tenant' %}
        <a href="{{ url_for('tenant.pay_rent') }}" class="btn btn-sm btn-info mt-2">Make Payment</a>
      {% endif %}
    {% else %}
      <a href="{{ url_for('auth.login') }}" class="btn btn-sm btn-primary mt-2">Login to Chat</a>
    {% endif %}
  </div>
  <button id="open-chat" class="chat-button btn btn-primary">
    <i class="fas fa-comment-dots"></i> Chat with Support
  </button>
</div>

<!-- JavaScript for Chat Widget -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const socket = io();
  const userId = {{ (current_user.id if current_user.is_authenticated else 0) | tojson }};
  const userName = {{ (current_user.name if current_user.is_authenticated else "Guest") | tojson }};

  document.getElementById('open-chat').addEventListener('click', () => {
      document.getElementById('chat-widget').style.display = 'block';
      socket.emit('load_history', { user_id: userId });
  });

  document.getElementById('close-chat').addEventListener('click', () => {
      document.getElementById('chat-widget').style.display = 'none';
  });

  document.getElementById('chat-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const message = document.getElementById('chat-input').value.trim();
      if (message) {
          socket.emit('message', {
              user_id: userId,
              name: userName,
              message: message
          });
          document.getElementById('chat-input').value = '';
      }
  });

  document.getElementById('upload-file-btn').addEventListener('click', () => {
      document.getElementById('file-input').click();
  });

  document.getElementById('file-input').addEventListener('change', () => {
      const form = document.getElementById('file-form');
      const formData = new FormData(form);
      fetch('{{ url_for("support.upload_file") }}', {
          method: 'POST',
          body: formData
      })
      .then(response => response.json())
      .then(data => {
          if (data.file_url) {
              socket.emit('message', {
                  user_id: userId,
                  name: userName,
                  message: `File uploaded: <a href="${data.file_url}" target="_blank">${data.filename}</a>`
              });
          } else {
              alert('File upload failed: ' + (data.error || 'Unknown error'));
          }
      })
      .catch(error => {
          console.error('Error uploading file:', error);
          alert('Error uploading file.');
      });
      form.reset();
  });

  socket.on('message', (data) => {
      const messages = document.getElementById('chat-messages');
      const li = document.createElement('li');
      li.className = `message ${data.user_id == userId ? 'sent' : 'received'} mb-2`;
      li.innerHTML = `<strong>${data.user_id == userId ? userName : 'Support'}:</strong> ${data.message} <small>${new Date(data.timestamp).toLocaleTimeString()}</small>`;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
  });

  socket.on('load_history', (messages) => {
      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML = '';
      messages.forEach(msg => {
          const li = document.createElement('li');
          li.className = `message ${msg.user_id == userId ? 'sent' : 'received'} mb-2`;
          li.innerHTML = `<strong>${msg.user_id == userId ? userName : 'Support'}:</strong> ${msg.message} <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>`;
          messagesDiv.appendChild(li);
      });
      messagesDiv.scrollTop = messages.scrollHeight;
  });

  if (Notification.permission === 'granted') {
      socket.on('message', (data) => {
          if (data.user_id != userId) {
              new Notification('New Support Message', {
                  body: `${data.name}: ${data.message}`,
                  icon: '/static/images/favicon.ico'
              });
          }
      });
  } else if (Notification.permission !== 'denied') {
      Notification.requestPermission();
  }
</script>
{% endblock %}
