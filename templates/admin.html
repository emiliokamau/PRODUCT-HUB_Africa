{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="admin-container">
  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <h2>Admin Panel</h2>
    <ul>
      <li><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
      <li>
        <a href="#" class="dropdown-toggle" data-target="sub-menu-users">Manage Users</a>
        <ul class="sub-menu" id="sub-menu-users">
          <li><a href="#" onclick="showTab('users')">Users</a></li>
        </ul>
      </li>
      <li>
        <a href="#" class="dropdown-toggle" data-target="sub-menu-properties">Manage Properties</a>
        <ul class="sub-menu" id="sub-menu-properties">
          <li><a href="#" onclick="showTab('properties')">Properties</a></li>
        </ul>
      </li>
      <li>
        <a href="#" class="dropdown-toggle" data-target="sub-menu-reports">Reports</a>
        <ul class="sub-menu" id="sub-menu-reports">
          <li><a href="#" onclick="showTab('reports')">Reports</a></li>
        </ul>
      </li>
      <li><a href="{{ url_for('admin.platform_settings') }}" class="btn btn-secondary">Platform Settings</a></li>
      <li><a href="{{ url_for('auth.support') }}" class="btn btn-help">Need Help?</a></li>
      <li><a href="{{ url_for('auth.profile') }}">Profile</a></li>
      <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
    </ul>
    <aside class="tips-sidebar">
      <h3>Admin Tips</h3>
      <ul>
        <li>Use filters to manage large user bases.</li>
        <li>Monitor user activity regularly.</li>
      </ul>
      <button class="toggle-tips">Toggle Tips</button>
    </aside>
  </aside>

  <!-- Main Content -->
  <main class="admin-main">
    <h1 style="color: #3D8B40;">Admin Dashboard</h1>
    <p>Manage users, properties, and platform operations.</p>

    <!-- Notifications Section -->
    <section class="notifications">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'error' }}" style="color: {{ '#4A90E2' if category == 'success' else '#B22222' }};">
        {{ message }}
      </div>
      {% endfor %}
      {% endif %}
      {% endwith %}
    </section>

    <!-- System Overview -->
    <section class="system-overview" style="background: #F5E8C7; color: #1A1A1A;">
      <h2>System Overview</h2>
      <div class="card">Total Users: {{ stats.total_users }}</div>
      <div class="card">Total Properties: {{ stats.total_properties }}</div>
      <div class="card">Total Transactions: {{ stats.total_transactions }}</div>
    </section>

    <!-- Platform Health Metrics -->
    <section class="health-metrics">
      <h2>Platform Health</h2>
      <div class="card" style="color: {{ '#4A90E2' if stats.uptime >= 99 else '#B22222' }};">
        Server Uptime: {{ stats.uptime }}%
      </div>
      <div class="card" style="color: {{ '#4A90E2' if stats.api_response <= 300 else '#B22222' }};">
        API Response: {{ stats.api_response }}ms
      </div>
    </section>

<!-- Language Toggle -->
<section class="language-toggle-section">
  <button class="language-toggle" style="background: #3D8B40; color: white;" onclick="toggleLanguage()">
    Switch to {{ 'Swahili' if current_user.language == 'English' else 'English' }}
  </button>
  <form id="language-form" action="{{ url_for('admin.set_language') }}" method="POST">
    <select name="language" onchange="this.form.submit()" value="{{ current_user.language }}">
      <option value="English" {% if current_user.language == 'English' %}selected{% endif %}>English</option>
      <option value="Swahili" {% if current_user.language == 'Swahili' %}selected{% endif %}>Swahili</option>
    </select>
  </form>
</section>


    <!-- Filters Section -->
    <section class="filters">
      <form action="{{ url_for('admin.dashboard') }}" method="GET">
        <input type="text" name="user_search" placeholder="Search by name, email, or phone">
        <select name="role_filter">
          <option value="All">All</option>
          <option value="Landlord">Landlord</option>
          <option value="Tenant">Tenant</option>
          <option value="Service Provider">Service Provider</option>
          <option value="Admin">Admin</option>
        </select>
        <select name="property_filter">
          <option value="All">All Properties</option>
          {% for property in properties %}
          <option value="{{ property.id }}">{{ property.name }}, {{ property.location }}</option>
          {% endfor %}
        </select>
        <select name="transaction_type">
          <option value="All">All</option>
          <option value="Rent Payments">Rent Payments</option>
          <option value="Service Payments">Service Payments</option>
          <option value="Refunds">Refunds</option>
        </select>
        <select name="maintenance_status">
          <option value="All">All</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
        </select>
        <input type="date" name="start_date" placeholder="2025-01-01">
        <input type="date" name="end_date" placeholder="2025-12-31">
      </form>
    </section>

    <!-- Platform Announcement -->
    <section class="platform-announcement">
      <form action="{{ url_for('admin.send_announcement') }}" method="POST">
        <textarea name="announcement" placeholder="Enter platform announcement"></textarea>
        <button type="submit" class="btn btn-primary" style="background: #3D8B40; color: white;">Send Announcement</button>
      </form>
    </section>

    <!-- Tabs -->
    <section class="tabs">
      <!-- Users Tab -->
      <div id="users" class="tab-content" style="display: none">
        <h2 style="color: #1A1A1A;">All Users</h2>
        <form action="{{ url_for('admin.bulk_action') }}" method="POST">
          <select name="bulk_action">
            <option value="suspend">Suspend</option>
            <option value="notify">Notify</option>
          </select>
          <button type="submit" class="btn btn-primary" style="background: #3D8B40;">Apply Bulk Action</button>
          <table class="users-table" style="color: #1A1A1A;">
            <tr>
              <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
            {% for user in users %}
            <tr>
              <td><input type="checkbox" name="bulk_select" value="{{ user.id }}"></td>
              <td>{{ user.name }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.role }}</td>
              <td>{{ user.contact }}</td>
              <td>{{ user.status }}</td>
              <td>{{ user.last_login | datetimeformat }}</td>
              <td>
                <form action="{{ url_for('admin.user_action', user_id=user.id) }}" method="POST" style="display: inline;">
                  <button name="action" value="suspend" style="background: #B22222; color: white;">Suspend</button>
                  <button name="action" value="reactivate" style="background: #3D8B40; color: white;">Reactivate</button>
                </form>
                <button onclick="showUserDetails('{{ user.id }}')" style="background: #F5E8C7; color: #1A1A1A;">View</button>
              </td>
            </tr>
            {% endfor %}
          </table>
        </form>
      </div>

      <!-- Properties Tab -->
      <div id="properties" class="tab-content" style="display: none">
        <h2 style="color: #1A1A1A;">All Properties</h2>
        <form action="{{ url_for('admin.bulk_action') }}" method="POST">
          <select name="bulk_action">
            <option value="suspend">Suspend</option>
            <option value="notify">Notify</option>
          </select>
          <button type="submit" class="btn btn-primary" style="background: #3D8B40;">Apply Bulk Action</button>
          <table class="properties-table" style="color: #1A1A1A;">
            <tr>
              <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
              <th>Name</th>
              <th>Location</th>
              <th>Landlord</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
            {% for house in houses %}
            <tr>
              <td><input type="checkbox" name="bulk_select" value="{{ house.id }}"></td>
              <td>{{ house.title }}</td>
              <td>{{ house.location }}</td>
              <td>{{ house.owner.name }}</td>
              <td>{{ house.status }}</td>
              <td>
                <form action="{{ url_for('admin.delete_property', house_id=house.id) }}" method="POST" style="display: inline;">
                  <button type="submit">Remove</button>
                </form>
                <button onclick="showPropertyDetails('{{ house.id }}')">View</button>
              </td>
            </tr>
            {% endfor %}
          </table>
        </form>
      </div>

      <!-- Reports Tab -->
      <div id="reports" class="tab-content" style="display: none">
        <h2>Reports</h2>
        <a href="{{ url_for('admin.export_reports') }}" class="btn btn-primary" style="background: #3D8B40; color: white;">Export Reports</a>
        <a href="{{ url_for('admin.download_audit_log') }}" class="btn btn-primary" style="background: #3D8B40; color: white;">Download Audit Log</a>
        <p>No reports yet.</p>
      </div>

      <!-- Transactions Tab -->
      <div id="transactions" class="tab-content" style="display: none">
        <h2 style="color: #1A1A1A;">Transaction Summary</h2>
        <table class="transactions-table" style="color: #1A1A1A;">
          <tr>
            <th>Amount</th>
            <th>Type</th>
            <th>Date</th>
          </tr>
          {% for transaction in transactions %}
          <tr>
            <td>KES {{ transaction.amount }}</td>
            <td>{{ transaction.type }}</td>
            <td>{{ transaction.date | datetimeformat }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <!-- Maintenance Tab -->
      <div id="maintenance" class="tab-content" style="display: none">
        <h2 style="color: #1A1A1A;">Maintenance Requests</h2>
        <section class="maintenance-overview" style="background: #F5E8C7; color: #1A1A1A;">
          <div class="card">Total Requests: {{ stats.maintenance_total }}</div>
          <div class="card">Open: {{ stats.maintenance_open }}</div>
          <div class="card">Resolved: {{ stats.maintenance_resolved }}</div>
        </section>
      </div>

      <!-- Feedback Tab -->
      <div id="feedback" class="tab-content" style="display: none">
        <h2 style="color: #1A1A1A;">User Feedback</h2>
        <section class="feedback-summary" style="background: #F5E8C7; color: #1A1A1A;">
          <div class="card">Total Tickets: {{ stats.feedback_total }}</div>
          <div class="card">Open: {{ stats.feedback_open }}</div>
          <div class="card">Resolved: {{ stats.feedback_resolved }}</div>
        </section>
      </div>
    </section>

    <!-- Recent Activity Log -->
    <section class="activity-log" style="color: #1A1A1A;">
      <h2>Recent Activity</h2>
      {% for activity in activities %}
      <p>{{ activity.description }}, {{ activity.timestamp | datetimeformat }}</p>
      {% endfor %}
    </section>

    <!-- Security Alerts -->
    <section class="security-alerts" style="color: #B22222;">
      <h2>Security Alerts</h2>
      {% for alert in security_alerts %}
      <p>{{ alert.description }} on {{ alert.timestamp | datetimeformat }}</p>
      {% endfor %}
    </section>

    <!-- User Activity Chart -->
    <section class="user-activity-chart">
      <h2>User Activity Trends</h2>
      <canvas id="activityChart"></canvas>
    </section>

    <!-- Quick Links -->
    <section class="quick-links">
      <h2>Quick Links</h2>
      <a href="{{ url_for('admin.manage_users') }}" class="btn btn-primary" style="background: #3D8B40; color: white;">Manage Users</a>
      <a href="{{ url_for('admin.export_reports') }}" class="btn btn-primary" style="background: #3D8B40; color: white;">View Reports</a>
    </section>
  </main>

  <!-- User Details Modal -->
  <div class="modal" id="user-details-modal" style="background: #F5E8C7; color: #1A1A1A;">
    <div class="modal-content">
      <h2>User Details</h2>
      <p id="modal-user-name"></p>
      <p id="modal-user-email"></p>
      <p id="modal-user-contact"></p>
      <p id="modal-user-activity"></p>
      <button onclick="closeModal('user-details-modal')">Close</button>
    </div>
  </div>
</div>

<style>
  .admin-container {
    display: flex;
  }
  .admin-sidebar {
    width: 220px;
    background: #2c3e50;
    color: white;
    padding: 20px;
    height: 100vh;
    position: fixed;
    top: 56px;
    left: 0;
  }
  .admin-sidebar ul {
    list-style: none;
    padding: 0;
  }
  .admin-sidebar ul li {
    margin-bottom: 10px;
  }
  .admin-sidebar ul li a, .admin-sidebar .btn {
    color: white;
    text-decoration: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .admin-sidebar ul li a:hover, .admin-sidebar .btn:hover {
    color: #d3d3d3;
  }
  .tips-sidebar {
    background: #F5E8C7;
    color: #1A1A1A;
    padding: 10px;
    margin-top: 20px;
  }
  .tips-sidebar .toggle-tips {
    cursor: pointer;
    background: #3D8B40;
    color: white;
    border: none;
    padding: 5px 10px;
  }
  .admin-main {
    flex: 1;
    padding: 20px;
    margin-left: 220px;
    margin-top: 56px;
  }
  .summary, .system-overview, .health-metrics, .quick-links {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }
  .card {
    background: #f4f4f4;
    padding: 10px 20px;
    border-radius: 6px;
  }
  .filters form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .filters input, .filters select {
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .platform-announcement textarea {
    width: 100%;
    height: 100px;
    margin-bottom: 10px;
  }
  .tab-content {
    margin-top: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  table th, table td {
    padding: 10px;
    border: 1px solid #ddd;
  }
  .btn-help {
    background: #F28C38;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
  }
  .modal-content {
    background: #F5E8C7;
    margin: 15% auto;
    padding: 20px;
    width: 70%;
    border-radius: 6px;
  }
  .user-activity-chart canvas {
    max-width: 600px;
  }
  .dark-mode .card, .dark-mode .system-overview, .dark-mode .maintenance-overview, .dark-mode .feedback-summary {
    background: #2c2c2c;
    color: #ffffff;
  }
  .dark-mode .admin-main {
    background: #1a1a1a;
  }
  .sub-menu {
    display: none;
    padding-left: 20px;
  }
  .sub-menu.active {
    display: block;
  }
</style>

<script>
  function showTab(tabId) {
    document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
    document.getElementById(tabId).style.display = "block";
  }

  function toggleAllCheckboxes(source) {
    document.querySelectorAll("input[name='bulk_select']").forEach(checkbox => {
      checkbox.checked = source.checked;
    });
  }

  function showUserDetails(userId) {
    // Fetch user details via AJAX or populate from template
    document.getElementById("user-details-modal").style.display = "block";
    // Example: Populate modal with dummy data
    document.getElementById("modal-user-name").textContent = "Name: John Doe";
    document.getElementById("modal-user-email").textContent = "Email: example@email.com";
    document.getElementById("modal-user-contact").textContent = "Contact: +254712345678";
    document.getElementById("modal-user-activity").textContent = "Recent Activity: Logged in on 2025-08-22";
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
  }

  function toggleLanguage() {
    document.getElementById("language-form").submit();
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".dropdown-toggle").forEach(toggle => {
      toggle.addEventListener("click", e => {
        e.preventDefault();
        const targetId = toggle.getAttribute("data-target");
        const subMenu = document.getElementById(targetId);
        const isActive = subMenu.classList.contains("active");
        document.querySelectorAll(".sub-menu").forEach(menu => menu.classList.remove("active"));
        document.querySelectorAll(".dropdown-toggle").forEach(t => t.classList.remove("active"));
        if (!isActive) {
          subMenu.classList.add("active");
          toggle.classList.add("active");
        }
        const tabId = targetId.replace("sub-menu-", "");
        showTab(tabId);
      });
    });

    document.querySelector(".toggle-tips").addEventListener("click", () => {
      const tips = document.querySelector(".tips-sidebar ul");
      tips.style.display = tips.style.display === "none" ? "block" : "none";
    });

    // Chart.js for User Activity
    const ctx = document.getElementById("activityChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: [{% for day in range(30) %}"{{ day }}",{% endfor %}],
        datasets: [{
          label: "User Logins",
          data: [{% for login in stats.daily_logins %}{{ login }},{% endfor %}],
          borderColor: "#3D8B40",
          backgroundColor: "#4A90E2",
          fill: false
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}